{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
    "parameters": {
        "vmName": {
            "type": "string",
            "metadata": {
                "description": "Name of the existing VM to apply the custom script to"
            }
        },
        "scriptFiles": {
            "type": "array",
            "metadata": {
                "description": "Full path of the script file to setup Azbet database."
            }
        },
        "scriptName": {
            "type": "string",
            "metadata": {
                "description": "Full name of the script file (with extension) to run in order to setup Azbet database."
            }
        },
        "StorageAccessKey": {
            "type": "string",
            "metadata": {
                "description": "Storage account Access Key to get Azbet binaries from Azure drop location."
            }
        },
        "AzureEnvironmentName": {
            "type": "string",
            "metadata": {
                "description": "Environment name in Azure to get the latest Azbet drop from."
            }
        },
        "StorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "Storage account in Azure to get the latest Azbet drop from."
            }
        },
        "AzureContainerName": {
            "type": "string",
            "metadata": {
                "description": "Container name in Azure to get the latest Azbet drop from."
            }
        },
        "AzureBlobName": {
            "type": "string",
            "metadata": {
                "description": "Blob name in Azure to get the latest Azbet drop from."
            }
        },
        "SqlServerName": {
            "type": "string",
            "metadata": {
                "description": "Name of SQL server."
            }
        },
        "DatabaseName": {
            "type": "string",
            "metadata": {
                "description": "Name for Azbet database."
            }
        },
        "SqlAdminUserName": {
            "type": "string",
            "metadata": {
                "description": "SQL Admin username."
            }
        },
        "SqlAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "SQL Admin password."
            }
        },
        "CertificateToImport": {
            "type": "string",
            "metadata": {
                "description": "Certificate to import."
            }
        },
        "CertificatePassword": {
            "type": "securestring",
            "metadata": {
                "description": "Certificate password."
            }
        },
        "DeploymentEnvironmentName": {
            "type": "string",
            "metadata": {
                "description": "Name of the deployment environment."
            },
            "defaultValue": "azbetazstacktest"
        }
    },
    "variables": {
        "keyParam": "[concat(' -StorageAccessKey ', parameters('StorageAccessKey') )]",
        "envParam": "[concat(' -AzureEnvironmentName ', parameters('AzureEnvironmentName') )]",
        "storageAcct": "[concat(' -StorageAccountName ', parameters('StorageAccountName') )]",
        "containerParam": "[concat(' -AzureContainerName ', parameters('AzureContainerName') )]",
        "blobParam": "[concat(' -AzureBlobName ', parameters('AzureBlobName') )]",
        "sqlServerParam": "[concat(' -SqlServerName ', parameters('SqlServerName') )]",
        "sqlDatabaseParam": "[concat(' -DatabaseName ', parameters('DatabaseName') )]",
        "sqlAdminUserNameParam": "[concat(' -SqlAdminUserName ', parameters('SqlAdminUserName') )]",
        "sqlAdminPasswordParam": "[concat(' -SqlAdminPassword ', parameters('SqlAdminPassword') )]",
        "certificateNameParam": "[concat(' -CertificateToImport ', parameters('CertificateToImport') )]",
        "certificatePasswordParam": "[concat(' -CertificatePassword ', parameters('CertificatePassword') )]",
        "deploymentEnvironmentNameParam": "[concat(' -DeploymentEnvironmentName ', parameters('DeploymentEnvironmentName') )]",
        "commandParam": "[concat(variables('keyParam'), variables('envParam'), variables('storageAcct'), variables('containerParam'), variables('blobParam'), variables('sqlServerParam'), variables('sqlDatabaseParam'), variables('sqlAdminUserNameParam'), variables('sqlAdminPasswordParam'), variables('certificateNameParam'), variables('certificatePasswordParam'), variables('deploymentEnvironmentNameParam'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('vmName'),'/CustomScriptExtension')]",
            "apiVersion": "2015-06-15",
            "location": "[resourceGroup().location]",
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.8",
                "autoUpgradeMinorVersion": "true",
                "settings": {
                    "fileUris": "[parameters('scriptFiles')]",
                    "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -file ',parameters('scriptName'), variables('commandParam'))]"
                }
            }
        }
    ],
    "outputs": { }
    }
