{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "domainName": {
            "type": "string",
            "metadata": {
                "description": "The domain name needs to be consisting of one or more labels separated by . E.g. contoso.com"
            },
            "defaultValue": "contoso.com"
        },
        "sqlInstallationISOUri": {
            "type": "string",
            "metadata": {
                "description": "The Uri to the SQL Server installation ISO. E.g http://care.dlservice.microsoft.com/dl/download/2/F/8/2F8F7165-BB21-4D1E-B5D8-3BD3CE73C77D/SQLServer2014SP1-FullSlipstream-x64-ENU.iso"
            },
            "defaultValue": "http://care.dlservice.microsoft.com/dl/download/2/F/8/2F8F7165-BB21-4D1E-B5D8-3BD3CE73C77D/SQLServer2014SP1-FullSlipstream-x64-ENU.iso"
        },
        "sqlServerServiceAccountUserName": {
            "type": "string",
            "metadata": {
                "description": "The SQL Server Service account name"
            },
            "defaultValue": "sa"
        },
        "DatabaseName": {
            "type": "string",
            "metadata": {
                "description": "Name for Azbet database."
            },
            "defaultValue": "AzbetDB"
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "The name of the Administrator of the new VMs and Domain"
            },
            "defaultValue": "lcladmin"
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the Administrator account of the new VMs and Domain"
            },
            "defaultValue": "[concat('Subscription#',subscription().subscriptionId)]"
        },
        "CertificateToImport": {
            "type": "string",
            "metadata": {
                "description": "The name of the certificate as stored in the Azure blob."
            },
            "defaultValue": "AzThings.pfx"
        },
        "CertificatePassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the certificate."
            },
            "defaultValue": "[concat('Subscription#',subscription().subscriptionId)]"
        },
        "windowsImageSKU": {
            "type": "string",
            "metadata": {
                "description": "The Windows image SKU name."
            },
            "defaultValue": "2012-R2-Datacenter"
        },
        "numberOfWebSrvs": {
            "type": "int",
            "metadata": {
                "description": "Number of Web Servers"
            },
            "allowedValues": [
                1,
                2,
                3,
                4
            ],
            "defaultValue": 2
        },
        "numberOfLoadgenSrvs": {
            "type": "int",
            "metadata": {
                "description": "Number of LoadGen Servers"
            },
            "allowedValues": [
                1,
                2,
                3,
                4
            ],
            "defaultValue": 2
        },
        "StorageAccessKey": {
            "type": "string",
            "metadata": {
                "description": "Storage account Access Key to get Azbet binaries from Azure drop location."
            }
        },
        "AzureEnvironmentName": {
            "type": "string",
            "metadata": {
                "description": "Environment name in Azure to get the latest Azbet drop from."
            }
        },
        "StorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "Storage account in Azure to get the latest Azbet drop from."
            }
        },
        "AzureContainerName": {
            "type": "string",
            "metadata": {
                "description": "Container name in Azure to get the latest Azbet drop from."
            }
        },
        "AzbetDatabaseAzureBlobName": {
            "type": "string",
            "metadata": {
                "description": "Blob name of Azbet database package in Azure to get the latest drop."
            },
            "defaultValue": "Database.zip"
        },
        "AzbetWebsiteAzureBlobName": {
            "type": "string",
            "metadata": {
                "description": "Blob name of Azbet website package in Azure to get the latest drop."
            },
            "defaultValue": "AzBet.zip"
        },
        "LoadGenAzureBlobName": {
            "type": "string",
            "metadata": {
                "description": "Blob name of Azbet website package in Azure to get the latest drop."
            },
            "defaultValue": "RoboCustosWindowsService.zip"
        },
        "EnvironmentRegion": {
            "type": "string",
            "metadata": {
                "description": "Region of the Azure Stack environment."
            },
            "defaultValue": "local"
        },
        "ExternalFQDN": {
            "type": "string",
            "metadata": {
                "description": "Complete external fqdn."
            },
            "defaultValue": "ext-s11r1701.masd.stbtest.microsoft.com"
        },
        "DeploymentEnvironmentName": {
            "type": "string",
            "metadata": {
                "description": "Name of the deployment environment."
            },
            "defaultValue": "azbetazstacktest"
        }
    },
    "variables": {
        "sqlassetLocation": "https://raw.githubusercontent.com/sumantshiv/AzureStack-QuickStart-Templates/azbetIaas/sql-2014-non-ha",
        "adAssetLocation": "https://raw.githubusercontent.com/sumantshiv/AzureStack-QuickStart-Templates/azbetIaas/ad-non-ha",
        "azbetAssetLocation": "https://raw.githubusercontent.com/sumantshiv/AzureStack-QuickStart-Templates/azbetIaas/Azbet",
        "configureAzbetDBTemplateURL": "[concat(variables('azbetAssetLocation'),'/deployAzbetDBOnNode.json')]",
        "configureAzbetDBScriptName": "ConfigureSqlDB.ps1",
        "configureAzbetDBScripts": [ "[concat(variables('azbetAssetLocation'), '/', variables('configureAzbetDBScriptName'))]", "[concat(variables('azbetAssetLocation'), '/', 'SetupAzbet.psm1')]" ],
        "configureAzbetWebsiteTemplateURL": "[concat(variables('azbetAssetLocation'),'/deployAzbetWebsiteOnNode.json')]",
        "configureAzbetWebsiteScriptName": "ConfigureWebRole.ps1",
        "configureAzbetWebScripts": [ "[concat(variables('azbetAssetLocation'), '/', variables('configureAzbetWebsiteScriptName'))]", "[concat(variables('azbetAssetLocation'), '/', 'SetupAzbet.psm1')]" ],
        "configureLoadGenTemplateURL": "[concat(variables('azbetAssetLocation'),'/deployLoadGenOnNode.json')]",
        "configureLoadGenScriptName": "ConfigureLoadGen.ps1",
        "configureLoadGenScripts": [ "[concat(variables('azbetAssetLocation'), '/', variables('configureLoadGenScriptName'))]", "[concat(variables('azbetAssetLocation'), '/', 'SetupAzbet.psm1')]", "[concat(variables('azbetAssetLocation'), '/', 'Deploy-RoboCustos-WindowsService-Remote.ps1')]" ],
        "location": "[resourceGroup().location]",
        "sqlServerServiceAccountPassword": "[parameters('adminPassword')]",
        "vmNetworkSubnet": "10.0.0.0/24",
        "virtualNetworkAddressRange": "10.0.0.0/16",
        "primaryIpADAddress": "10.0.0.4",
        "storageAccountType": "Standard_LRS",
        "adVMSize": "Standard_A1",
        "sqlVMSize": "Standard_A3",
        "staticSubnetName": "[concat('SQLSub',resourceGroup().name)]",
        "dnsPrefix": "[tolower(concat(resourceGroup().name,'dc'))]",
        "virtualNetworkName": "[concat('SQLVNet',resourceGroup().name)]",
        "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
        "staticSubnetID": "[concat(variables('vnetID'),'/subnets/',variables('staticSubnetName'))]",
        "adTemplateURL": "[concat(variables('adAssetLocation'),'/adVmTemplate.json')]",
        "adStorageName": "[tolower(concat('adsa',resourceGroup().name))]",
        "adVmDeployment": "CreateAdVms",
        "adVmDeploymentId": "[concat('Microsoft.Resources/deployments/', variables('adVmDeployment'))]",
        "deployPrimaryAdTemplateURL": "[concat(variables('adAssetLocation'),'/deployPrimaryAD.json')]",
        "deployPrimaryAd": "DeployPrimaryAd",
        "deployPrimaryAdID": "[concat('Microsoft.Resources/deployments/', variables('deployPrimaryAd'))]",
        "sqlStorageName": "[tolower(concat('sqlsa',resourceGroup().name))]",
        "sqlClusterTemplateURL": "[concat(variables('sqlassetLocation'),'/sqlVmTemplate.json')]",
        "deploySqlClusterVms": "CreateSqlClusterVms",
        "deploySqlClusterVmsID": "[concat('Microsoft.Resources/deployments/', variables('deploySqlClusterVms'))]",
        "adPDCVMName": "[concat('SQLAD',resourceGroup().name)]",
        "vnetwithDNSTemplateURL": "[concat(variables('adAssetLocation'),'/vnet-with-dns-server.json')]",
        "updateVNetDNS1": "updateVNetDNS1",
        "updateVNetDNS1ID": "[concat('Microsoft.Resources/deployments/', variables('updateVNetDNS1'))]",
        "sqlClusterVmName": "[concat('SQL',resourceGroup().name)]",
        "webSrvName": "[concat(resourcegroup().name, 'webSrv')]",
        "deploySqlStandalone": "DeploySqlStandalone",
        "deployWebRole": "DeployWebrole",
        "webLbName": "[concat(variables('webSrvName'), 'lb')]",
        "AzBetTargetUrl": "[concat('https://', variables('webLbName'), '.', parameters('EnvironmentRegion'), '.cloudapp.', parameters('ExternalFQDN'))]",
        "deploySqlStandaloneTemplateURL": "[concat(variables('sqlassetLocation'),'/deploySqlStandalone.json')]",
        "publicLBName": "[concat('SQLPLB',resourceGroup().name)]",
        "publicIPAddressName": "[concat('SQLPIP',resourceGroup().name)]",
        "publicIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]",
        "lbFE": "SQLLBFE",
        "rpdNAT": "SQLRDPNAT",
        "publiclbID": "[resourceId('Microsoft.Network/loadBalancers',variables('publicLBName'))]",
        "publiclbFEConfigID": "[concat(variables('publiclbID'),'/frontendIPConfigurations/',variables('lbFE'))]",
        "rdpPort": 3389,
        "adRDPNATRuleID": "[concat(variables('publiclbID'),'/inboundNatRules/',variables('rpdNAT'))]",
        "adNICName": "[concat('SQLADNic',resourceGroup().name)]",
        "sqlNICName": "[concat('SQLNic',resourceGroup().name)]",
        "nsgName": "SQLNsg",
        "nsgID": "[resourceId('Microsoft.Network/networkSecurityGroups',variables('nsgName'))]",
        "subnets": [
            {
                "name": "[variables('staticSubnetName')]",
                "properties": {
                    "addressPrefix": "[variables('vmNetworkSubnet')]",
                    "networkSecurityGroup": {
                        "id": "[variables('nsgID')]"
                    }
                }
            }
        ],
        "deployWebroleTemplateURL": "https://raw.githubusercontent.com/sumantshiv/azurestack-quickstart-templates/azbetIaas/WebRole/azuredeploy.json",
        "deployLoadgenroleTemplateURL": "https://raw.githubusercontent.com/sumantshiv/azurestack-quickstart-templates/azbetIaas/Multiple-Windows-VM/azuredeploy.json"
    },
    "resources": [
        {
            "name": "[variables('nsgName')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "location": "[variables('location')]",
            "apiVersion": "2015-06-15",
            "properties": {
                "securityRules": [
                    {
                        "name": "rule1",
                        "properties": {
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 101,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "name": "[variables('virtualNetworkName')]",
            "type": "Microsoft.Network/virtualNetworks",
            "location": "[variables('location')]",
            "apiVersion": "2015-06-15",
            "dependsOn": [
                "[variables('nsgID')]"
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('virtualNetworkAddressRange')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('staticSubnetName')]",
                        "properties": {
                            "addressPrefix": "[variables('vmNetworkSubnet')]",
                            "networkSecurityGroup": {
                                "id": "[variables('nsgID')]"
                            }
                        }
                    }
                ]
            }
        },
        {
            "name": "[variables('publicIPAddressName')]",
            "type": "Microsoft.Network/publicIPAddresses",
            "location": "[variables('location')]",
            "apiVersion": "2015-06-15",
            "dependsOn": [
                "[variables('vnetID')]"
            ],
            "properties": {
                "publicIPAllocationMethod": "Dynamic",
                "dnsSettings": {
                    "domainNameLabel": "[variables('dnsPrefix')]"
                }
            }
        },
        {
            "name": "[variables('publiclbName')]",
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2015-06-15",
            "location": "[variables('location')]",
            "dependsOn": [
                "[variables('publicIPAddressID')]"
            ],
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "[variables('lbFE')]",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[variables('publicIPAddressID')]"
                            }
                        }
                    }
                ],
                "inboundNatRules": [
                    {
                        "name": "[variables('rpdNAT')]",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('publiclbFEConfigID')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": "[variables('rdpPort')]",
                            "backendPort": 3389,
                            "enableFloatingIP": false
                        }
                    }
                ]
            }
        },
        {
            "name": "[variables('adVmDeployment')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('publiclbID')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('adTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "adRDPNATRuleID": {
                        "value": "[variables('adRDPNATRuleID')]"
                    },
                    "storageAccount": {
                        "value": "[variables('adStorageName')]"
                    },
                    "subnetResourceId": {
                        "value": "[variables('staticSubnetID')]"
                    },
                    "primaryAdIpAddress": {
                        "value": "[variables('primaryIpADAddress')]"
                    },
                    "storageAccountType": {
                        "value": "[variables('storageAccountType')]"
                    },
                    "windowsImageSKU": {
                        "value": "[parameters('windowsImageSKU')]"
                    },
                    "vmName": {
                        "value": "[variables('adPDCVMName')]"
                    },
                    "vmSize": {
                        "value": "[variables('adVMSize')]"
                    },
                    "adDNicName": {
                        "value": "[variables('adNICName')]"
                    }
                }
            }
        },
        {
            "name": "[variables('deploySqlClusterVms')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('adVmDeploymentID')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('sqlClusterTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "storageAccount": {
                        "value": "[variables('sqlStorageName')]"
                    },
                    "subnetResourceId": {
                        "value": "[variables('staticSubnetID')]"
                    },
                    "windowsImageSKU": {
                        "value": "[parameters('windowsImageSKU')]"
                    },
                    "vmName": {
                        "value": "[variables('sqlClusterVmName')]"
                    },
                    "storageAccountType": {
                        "value": "[variables('storageAccountType')]"
                    },
                    "vmSize": {
                        "value": "[variables('sqlVMSize')]"
                    },
                    "sqlNICName": {
                        "value": "[variables('sqlNICName')]"
                    }
                }
            }
        },
        {
            "name": "[variables('deployPrimaryAd')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('adVmDeploymentID')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('deployPrimaryAdTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "primaryADName": {
                        "value": "[variables('adPDCVMName')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "assetLocation": {
                        "value": "[variables('adAssetLocation')]"
                    }
                }
            }
        },
        {
            "name": "[variables('updateVNetDNS1')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('deployPrimaryAdID')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vnetwithDNSTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkName')]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[variables('virtualNetworkAddressRange')]"
                    },
                    "subnets": {
                        "value": "[variables('subnets')]"
                    },
                    "dnsServerAddress": {
                        "value": [
                            "[variables('primaryIpADAddress')]"
                        ]
                    }
                }
            }
        },
        {
            "name": "[variables('deploySqlStandalone')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('updateVNetDNS1ID')]",
                "[variables('deploySqlClusterVmsID')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('deploySqlStandaloneTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "sqlVMName": {
                        "value": "[variables('sqlClusterVmName')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "sqlInstallationISOUri": {
                        "value": "[parameters('sqlInstallationISOUri')]"
                    },
                    "sqlServerServiceAccountUserName": {
                        "value": "[parameters('sqlServerServiceAccountUserName')]"
                    },
                    "sqlServerServiceAccountPassword": {
                        "value": "[variables('sqlServerServiceAccountPassword')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "primaryAdIpAddress": {
                        "value": "[variables('primaryIpADAddress')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "assetLocation": {
                        "value": "[variables('sqlassetLocation')]"
                    }
                }
            }
        },
        {
            "name": "[variables('deployWebRole')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('deploySqlStandalone')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('deployWebroleTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "username": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "password": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "windowsImageSKU": {
                        "value": "[parameters('windowsImageSKU')]"
                    },
                    "numberOfWebSrvs": {
                        "value": "[parameters('numberOfWebSrvs')]"
                    },
                    "targetVMNetworkName": {
                        "value": "[variables('virtualNetworkName')]"
                    },
                    "targetVMNetworkSubnetName": {
                        "value": "[variables('staticSubnetName')]"
                    }
                }
            }
        },
        {
            "name": "DeployLoadgenrole",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('deployWebRole')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('deployLoadgenroleTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "domainAdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "domainAdminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "numberOfLoadgenSrvs": {
                        "value": "[parameters('numberOfLoadgenSrvs')]"
                    },
                    "targetVMNetworkName": {
                        "value": "[variables('virtualNetworkName')]"
                    },
                    "targetVMNetworkSubnetName": {
                        "value": "[variables('staticSubnetName')]"
                    },
                    "windowsOSVersion": {
                        "value": "[parameters('windowsImageSKU')]"
                    },
                    "vmName": {
                        "value": "LoadgenVM"
                    }
                }
            }
        },
        {
            "name": "ConfigureAzbetDB",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('deploySqlStandalone')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configureAzbetDBTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "scriptFiles": {
                        "value": "[variables('configureAzbetDBScripts')]"
                    },
                    "scriptName": {
                        "value": "[variables('configureAzbetDBScriptName')]"
                    },
                    "StorageAccessKey": {
                        "value": "[parameters('StorageAccessKey')]"
                    },
                    "AzureEnvironmentName": {
                        "value": "[parameters('AzureEnvironmentName')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "AzureContainerName": {
                        "value": "[parameters('AzureContainerName')]"
                    },
                    "AzureBlobName": {
                        "value": "[parameters('AzbetDatabaseAzureBlobName')]"
                    },
                    "SqlServerName": {
                        "value": "[variables('sqlClusterVmName')]"
                    },
                    "DatabaseName": {
                        "value": "[parameters('DatabaseName')]"
                    },
                    "SqlAdminUserName": {
                        "value": "[parameters('sqlServerServiceAccountUserName')]"
                    },
                    "SqlAdminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "vmName": {
                        "value": "[variables('sqlClusterVmName')]"
                    }
                }
            }
        },
        {
            "name": "[concat('ConfigureAzbetWebsite', copyindex())]",
            "type": "Microsoft.Resources/deployments",
            "copy": {
                "name": "websiteconfigure",
                "count": "[parameters('numberOfWebSrvs')]"
            },
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('deployWebRole')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configureAzbetWebsiteTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "scriptFiles": {
                        "value": "[variables('configureAzbetWebScripts')]"
                    },
                    "scriptName": {
                        "value": "[variables('configureAzbetWebsiteScriptName')]"
                    },
                    "StorageAccessKey": {
                        "value": "[parameters('StorageAccessKey')]"
                    },
                    "AzureEnvironmentName": {
                        "value": "[parameters('AzureEnvironmentName')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "AzureContainerName": {
                        "value": "[parameters('AzureContainerName')]"
                    },
                    "AzureBlobName": {
                        "value": "[parameters('AzbetWebsiteAzureBlobName')]"
                    },
                    "SqlServerName": {
                        "value": "[variables('sqlClusterVmName')]"
                    },
                    "DatabaseName": {
                        "value": "[parameters('DatabaseName')]"
                    },
                    "SqlAdminUserName": {
                        "value": "[parameters('sqlServerServiceAccountUserName')]"
                    },
                    "SqlAdminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "CertificateToImport": {
                        "value": "[parameters('CertificateToImport')]"
                    },
                    "CertificatePassword": {
                        "value": "[parameters('CertificatePassword')]"
                    },
                    "DeploymentEnvironmentName": {
                        "value": "[parameters('DeploymentEnvironmentName')]"
                    },
                    "vmName": {
                        "value": "[concat(variables('webSrvName'),copyindex())]"
                    }
                }
            }
        },
        {
            "name": "[concat('ConfigureLoadGen', copyindex())]",
            "type": "Microsoft.Resources/deployments",
            "copy": {
                "name": "loadgenconfigure",
                "count": "[parameters('numberOfLoadgenSrvs')]"
            },
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "DeployLoadgenrole"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('configureLoadGenTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "scriptFiles": {
                        "value": "[variables('configureLoadGenScripts')]"
                    },
                    "scriptName": {
                        "value": "[variables('configureLoadGenScriptName')]"
                    },
                    "StorageAccessKey": {
                        "value": "[parameters('StorageAccessKey')]"
                    },
                    "AzureEnvironmentName": {
                        "value": "[parameters('AzureEnvironmentName')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "AzureContainerName": {
                        "value": "[parameters('AzureContainerName')]"
                    },
                    "AzureBlobName": {
                        "value": "[parameters('LoadGenAzureBlobName')]"
                    },
                    "AzBetTargetUrl": {
                        "value": "[variables('AzBetTargetUrl')]"
                    },
                    "DeploymentEnvironmentName": {
                        "value": "[parameters('DeploymentEnvironmentName')]"
                    },
                    "vmName": {
                        "value": "[concat('LoadgenVM',copyindex())]"
                    }
                }
            }
        }
    ],
    "outputs": { }
}