{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "domainName": {
            "type": "string",
            "metadata": {
                "description": "The domain name needs to be consisting of one or more labels separated by . E.g. contoso.com"
            },
            "defaultValue": "contoso.com"
        },
        "sqlServerServiceAccountUserName": {
            "type": "string",
            "metadata": {
                "description": "The SQL Server Service account name"
            },
            "defaultValue": "sa"
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "The name of the Administrator of the new VMs and Domain"
            },
            "defaultValue": "lcladmin"
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the Administrator account of the new VMs and Domain"
            },
            "defaultValue": "[concat('Subscription#',subscription().subscriptionId)]"
        }
    },
    "variables": {
        "adAssetLocation": "https://raw.githubusercontent.com/sumantshiv/AzureStack-QuickStart-Templates/alwaysOn/ad-non-ha",
        "sqlassetLocation": "https://raw.githubusercontent.com/sumantshiv/AzureStack-QuickStart-Templates/alwaysOn/sql-2016-ha",
        "location": "[resourceGroup().location]",
        "nsgName": "AzbetNsg",
        "nsgID": "[resourceId('Microsoft.Network/networkSecurityGroups',variables('nsgName'))]",
        "vmNetworkSubnet": "10.0.0.0/24",
        "virtualNetworkAddressRange": "10.0.0.0/16",
        "primaryADIpAddress": "10.0.0.4",
        "virtualNetworkName": "[concat('PrvVNet',resourceGroup().name)]",
        "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
        "staticSubnetName": "[concat('PrvSub',resourceGroup().name)]",
        "staticSubnetID": "[concat(variables('vnetID'),'/subnets/',variables('staticSubnetName'))]",
        "dnsPrefix": "[tolower(concat(resourceGroup().name,'dc'))]",

        "publicADLBName": "[concat('ADPLB',resourceGroup().name)]",
        "publicADLBID": "[resourceId('Microsoft.Network/loadBalancers',variables('publicADLBName'))]",
        "publicADLBIPAddressName": "[concat('ADlbPublicIP',resourceGroup().name)]",
        "publicADLBIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicADLBIPAddressName'))]",
        "lbFE": "[concat('ADLBFE',resourceGroup().name)]",
        "publicADlbFEConfigID": "[concat(variables('publicADLBID'),'/frontendIPConfigurations/',variables('lbFE'))]",
        "rpdNAT": "[concat('ADRDPNAT',resourceGroup().name)]",
        "adRDPNATRuleID": "[concat(variables('publicADLBID'),'/inboundNatRules/',variables('rpdNAT'))]",
        "rdpPort": 3389,

        "adTemplateURL": "[concat(variables('adAssetLocation'),'/adVmTemplateWS2016.json')]",
        "adStorageName": "[tolower(concat('adsa',resourceGroup().name))]",
        "storageAccountType": "Standard_LRS",
        "adVMSize": "Standard_A1",
        "adNICName": "[concat('ADNic',resourceGroup().name)]",
        "adPDCVMName": "[concat('AD',resourceGroup().name)]",
        "adVmDeployment": "CreateAdVms",
        "adVmDeploymentId": "[concat('Microsoft.Resources/deployments/', variables('adVmDeployment'))]",
        "deployPrimaryAdTemplateURL": "[concat(variables('adAssetLocation'),'/deployPrimaryADOnWS2016.json')]",
        "deployPrimaryAd": "DeployPrimaryAd",
        "deployPrimaryAdID": "[concat('Microsoft.Resources/deployments/', variables('deployPrimaryAd'))]",
        "vnetwithDNSTemplateURL": "[concat(variables('adAssetLocation'),'/vnet-with-dns-server.json')]",
        "updateVNetDNS1": "updateVNetDNS1",
        "updateVNetDNS1ID": "[concat('Microsoft.Resources/deployments/', variables('updateVNetDNS1'))]",

        "sqlClusterTemplateURL": "[concat(variables('sqlassetLocation'),'/nested/deploy-sql-cluster.json')]",
        "sqlVMSize": "Standard_A3",
        "sqlWitnessVMSize": "Standard_A3",
        "sqlStorageName": "[tolower(concat('sqlsa',resourceGroup().name))]",
        "sqlServerServiceAccountPassword": "[parameters('adminPassword')]",
        "deploySqlAlwaysOnVms": "CreateSqlClusterVms",
        "deploySqlAlwaysOnVmsID": "[concat('Microsoft.Resources/deployments/', variables('deploySqlAlwaysOnVms'))]",
        "namePrefix": "[resourceGroup().name]",

        "subnets": [
            {
                "name": "[variables('staticSubnetName')]",
                "properties": {
                    "addressPrefix": "[variables('vmNetworkSubnet')]",
                    "networkSecurityGroup": {
                        "id": "[variables('nsgID')]"
                    }
                }
            }
        ]
    },
    "resources": [
        {
            "name": "[variables('nsgName')]",
            "type": "Microsoft.Network/networkSecurityGroups",
            "location": "[variables('location')]",
            "apiVersion": "2015-06-15",
            "properties": {
                "securityRules": [
                    {
                        "name": "rule1",
                        "properties": {
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 101,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "name": "[variables('virtualNetworkName')]",
            "type": "Microsoft.Network/virtualNetworks",
            "location": "[variables('location')]",
            "apiVersion": "2015-06-15",
            "dependsOn": [
                "[variables('nsgID')]"
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('virtualNetworkAddressRange')]"
                    ],
                    "networkSecurityGroup": {
                        "id": "[variables('nsgID')]"
                    }
                },
                "subnets": "[variables('subnets')]"
            }
        },
        {
            "name": "[variables('publicADLBIPAddressName')]",
            "location": "[resourceGroup().location]",
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2015-06-15",
            "dependsOn": [
                "[variables('vnetID')]"
            ],
            "properties": {
                "publicIPAllocationMethod": "Dynamic",
                "dnsSettings": {
                    "domainNameLabel": "[variables('dnsPrefix')]"
                }
            }
        },
        {
            "name": "[variables('publicADLBName')]",
            "location": "[resourceGroup().location]",
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2015-06-15",
            "dependsOn": [
                "[variables('publicADLBIPAddressID')]"
            ],
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "[variables('lbFE')]",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[variables('publicADLBIPAddressID')]"
                            }
                        }
                    }
                ],
                "inboundNatRules": [
                    {
                        "name": "[variables('rpdNAT')]",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('publicADlbFEConfigID')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": "[variables('rdpPort')]",
                            "backendPort": 3389,
                            "enableFloatingIP": false
                        }
                    }
                ]
            }
        },


        {
            "name": "[variables('adVmDeployment')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('publicADLBID')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('adTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "adRDPNATRuleID": {
                        "value": "[variables('adRDPNATRuleID')]"
                    },
                    "storageAccount": {
                        "value": "[variables('adStorageName')]"
                    },
                    "subnetResourceId": {
                        "value": "[variables('staticSubnetID')]"
                    },
                    "primaryAdIpAddress": {
                        "value": "[variables('primaryADIpAddress')]"
                    },
                    "storageAccountType": {
                        "value": "[variables('storageAccountType')]"
                    },
                    "vmName": {
                        "value": "[variables('adPDCVMName')]"
                    },
                    "vmSize": {
                        "value": "[variables('adVMSize')]"
                    },
                    "adDNicName": {
                        "value": "[variables('adNICName')]"
                    }
                }
            }
        },
        {
            "name": "[variables('deployPrimaryAd')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('adVmDeploymentId')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('deployPrimaryAdTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "primaryADName": {
                        "value": "[variables('adPDCVMName')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "assetLocation": {
                        "value": "[variables('adAssetLocation')]"
                    }
                }
            }
        },
        {
            "name": "[variables('updateVNetDNS1')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('deployPrimaryAdID')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vnetwithDNSTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkName')]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[variables('virtualNetworkAddressRange')]"
                    },
                    "subnets": {
                        "value": "[variables('subnets')]"
                    },
                    "dnsServerAddress": {
                        "value": [
                            "[variables('primaryADIpAddress')]"
                        ]
                    }
                }
            }
        },
        {
            "name": "[variables('deploySqlAlwaysOnVms')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "[variables('updateVNetDNS1ID')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('sqlClusterTemplateURL')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "namePrefix": {
                        "value": "[variables('namePrefix')]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "dnsServerName": {
                        "value": "[variables('adPDCVMName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "sqlServerServiceAccountUserName": {
                        "value": "[parameters('sqlServerServiceAccountUserName')]"
                    },
                    "sqlServerServiceAccountPassword": {
                        "value": "[variables('sqlServerServiceAccountPassword')]"
                    },
                    "storageAccountType": {
                        "value": "[variables('storageAccountType')]"
                    },
                    "nicSubnetUri": {
                        "value": "[variables('staticSubnetID')]"
                    },
                    "sqlVMSize": {
                        "value": "[variables('sqlVMSize')]"
                    },
                    "sqlWitnessVMSize": {
                        "value": "[variables('sqlWitnessVMSize')]"
                    },
                    "_artifactsLocation": {
                        "value": "[variables('sqlassetLocation')]"
                    }
                }
            }
        }
    ],
    "outputs": { }
}